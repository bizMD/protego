<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style>
			html, body {
				height: 100%;
				width: 100%;
				overflow: hidden;
				padding: 0px;
				margin: 0px;
			}

			path { fill: #ddc; }

			.ring {
				fill: none;
				stroke: #c7141a;
			}
		</style>
		<script src="/vendor/jquery"></script>
		<script src="/vendor/d3" charset="utf-8"></script>
		<script src="/vendor/topojson"></script>
		<script src="/vendor/oboe"></script>
		<script>
			var redAreas = function(){
				var locations = [];
				var locationsCount = Math.round((Math.random()*5)+1);
				for(var i = 0; i < locationsCount; i += 1){
					longitude = (Math.random() * 360) - 180;
					longitude *= Math.floor(Math.random()*2) == 1 ? 1 : -1;

					latitude = (Math.random() * 180) - 90;
					latitude *= Math.floor(Math.random()*2) == 1 ? 1 : -1;

					locations.push({
						longitude: longitude,
						latitude: latitude
					});
				}
				return locations;
			}

			var animate = function(svg, projection, height, width){
				redAreas().forEach(function(location){
					console.log(location);

					svg.append("circle")
						.attr("class", "dot ring")
						.attr("fill", "red")
						.style("stroke-width", 9)
						.attr("transform", "translate(" + projection([location.longitude, location.latitude]) + ")")
						.attr("opacity", "0")
						.attr("r", 2.5)
					.transition()
						.ease("linear")
						.duration(1000)
						.attr("r", 20)
						.style("stroke-width", 1)
						.style("stroke", "brown")
						.attr("opacity", "1")
						.delay(1000*(location.longitude+180)/36.36)
						.each("end", function(){
							d3.select(this).transition()
							.ease("linear")
							.duration(1000)
							.attr("r", 40)
							.style("opacity", "0")
							.remove();
						});
				});

				path = svg.append("line")
					.attr("id", "radar")
					.attr("x1", "0")
					.attr("y1", height)
					.attr("x2", "0")
					.attr("y2", "0")
					.attr("stroke", "#cdd")
					.attr("stroke-width", "4");
				
				path.transition()
					.ease("linear")
					.duration(10000)
					.attr("x1", '101%')
					.attr("x2", '101%')
					.remove()
			}

			$(document).ready(function(){
				var width = '100%',
				height = '100%',
				svg = d3.select('body')
					.append('svg')
					.attr('preserveAspectRatio', 'xMinYMin meet')
					.attr('width', width)
					.attr('height', height),
				projection = d3.geo.mercator();
				var pathEl;

				oboe('/world')
				.done(function(data){
					svg.append('path')
						.datum(topojson.feature(data, data.objects.subunits))
						.attr('d', d3.geo.path().projection(projection));
					
					animate(svg, projection, height, width);
					setInterval(function(){
						animate(svg, projection, height, width);
					}, 10000);
				});
			});
		</script>
	</head>
	<body>
	</body>
</html>